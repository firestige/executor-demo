# Phase 18 DDD 架构优化 - 行动计划速查表

**生成日期**: 2025-11-17  
**基于评审报告**: DDD_ARCHITECTURE_REVIEW_REPORT.md  
**当前状态**: 准备启动  

---

## 📊 现状与目标

| 指标 | 当前 | 目标 | 提升 |
|------|------|------|------|
| DDD 符合度 | 50% (13/26) | 80% (21/26) | +60% |
| 代码行数 | ~15,000 | ~13,500 | -10% |
| 测试覆盖率 | 60% | 85% | +40% |
| 可维护性评分 | 3/5 | 4.5/5 | +50% |

**预计总工作量**: 6-8 周  
**核心问题**: 贫血领域模型 + 聚合边界不清 + 原始类型泛滥

---

## 🎯 优先级一览

### 🔴 P0 - 最高优先级（2 周）

#### 1️⃣ RF-05: 清理孤立代码
- ⏱️ **时间**: 2-4 小时
- 🎯 **目标**: 删除 9 个孤立类，减少 ~1500 行代码
- 📦 **删除内容**:
  - `service.registry` 包（ServiceRegistry）
  - `service.strategy` 包（DirectRpcNotificationStrategy, RedisRpcNotificationStrategy）
  - `service.adapter` 包（ServiceNotificationAdapter）
  - Pipeline + PipelineStage（与 TaskStage 冲突）
  - CheckpointManager + InMemoryCheckpointManager（重复实现）
- ✅ **验收**: 测试通过 + 文档更新

#### 2️⃣ RF-06: 修复贫血聚合模型 ⭐ **最关键**
- ⏱️ **时间**: 1-2 天
- 🎯 **目标**: 将业务逻辑从服务层下沉到聚合
- 📝 **任务清单**:
  - [ ] TaskAggregate 添加 10+ 业务方法（start, pause, resume, completeStage 等）
  - [ ] PlanAggregate 添加 6+ 业务方法（addTask, start, pause 等）
  - [ ] 重构 TaskDomainService（职责简化为查询+持久化）
  - [ ] 重构 PlanDomainService（调用聚合方法）
  - [ ] 编写聚合单元测试（覆盖率 > 80%）
- ✅ **验收**: 业务逻辑内聚 + 服务层代码减少 30%

#### 3️⃣ RF-07: 修正聚合边界
- ⏱️ **时间**: 4-8 小时
- 🎯 **目标**: Plan 改为持有 taskIds 而非 Task 对象
- 📝 **任务清单**:
  - [ ] PlanAggregate: `List<TaskAggregate>` → `List<String> taskIds`
  - [ ] PlanDomainService.addTaskToPlan() 改为传递 taskId
  - [ ] DeploymentApplicationService 组装完整信息时查询 Tasks
  - [ ] 更新仓储实现和测试
- ✅ **验收**: 聚合边界清晰 + 事务边界明确

---

### 🟡 P1 - 中优先级（2-3 周）

#### 4️⃣ RF-08: 引入值对象
- ⏱️ **时间**: 1-2 天
- 🎯 **创建**: TaskId, TenantId, PlanId, DeployVersion, NetworkEndpoint
- 📈 **收益**: 类型安全提升 60%

#### 5️⃣ RF-09: 重构仓储接口
- ⏱️ **时间**: 1 天
- 🎯 **目标**: 分离 Repository 和 QueryService（CQRS）

#### 6️⃣ RF-10: 优化应用服务
- ⏱️ **时间**: 1 天
- 🎯 **目标**: 提取 DeploymentPlanCreator，简化应用服务

---

### 🟢 P2 - 低优先级（1 周）

#### 7️⃣ RF-11: 完善领域事件
- ⏱️ **时间**: 4-8 小时
- 🎯 **目标**: 事件由聚合产生

#### 8️⃣ RF-12: 添加事务标记
- ⏱️ **时间**: 2-4 小时
- 🎯 **目标**: @Transactional 明确事务边界

---

## 📅 执行时间表

### 第 1 周（11月18-22日）
- **周一上午**: RF-05 清理孤立代码（2-4小时）
- **周一下午 - 周三**: RF-06 修复贫血模型（2天）
  - 周一下午: TaskAggregate 业务方法
  - 周二: PlanAggregate + 重构服务层
  - 周三: 单元测试 + 集成测试
- **周四上午**: RF-07 修正聚合边界（4-8小时）
- **周四下午 - 周五**: 回归测试 + 文档更新

### 第 2-3 周（11月25日 - 12月6日）
- RF-08: 引入值对象（1-2天）
- RF-09: 重构仓储接口（1天）
- RF-10: 优化应用服务（1天）
- 回归测试 + 代码评审

### 第 4-5 周（12月9-20日）
- RF-11: 完善领域事件（4-8小时）
- RF-12: 添加事务标记（2-4小时）
- 全面回归测试
- 性能测试
- 文档完善

### 第 6 周（12月23-27日）
- 代码评审
- 知识分享会
- 发布 Phase 18 完成报告

---

## 🔍 每日检查清单

### 开发前
- [ ] 拉取最新代码
- [ ] 运行测试确保基线（mvn clean test）
- [ ] 创建新分支（feature/rf-0X-description）

### 开发中
- [ ] 遵循 DDD 最佳实践
- [ ] 编写单元测试（先写测试或同步编写）
- [ ] 代码自审（对照评审报告检查）

### 开发后
- [ ] 运行全部测试（mvn clean test）
- [ ] 检查测试覆盖率（mvn jacoco:report）
- [ ] 更新相关文档
- [ ] 提交 PR 并标注相关 RF 编号
- [ ] 在 TODO.md 中更新状态

---

## 📚 参考文档

| 文档 | 用途 |
|------|------|
| DDD_ARCHITECTURE_REVIEW_REPORT.md | 完整评审报告（问题分析+修改建议） |
| TODO.md | 详细任务跟踪 |
| ARCHITECTURE_PROMPT.md | 架构设计原则 |
| diagrams/10_class_diagram_ddd.puml | DDD 类图 |

---

## 🎯 关键成功指标（KSI）

### 代码质量
- [ ] DDD 符合度 ≥ 80%
- [ ] 单元测试覆盖率 ≥ 85%
- [ ] 集成测试全部通过（168+ tests）
- [ ] 无 P0/P1 级别的代码审查问题

### 架构改进
- [ ] 贫血模型问题完全解决
- [ ] 聚合边界清晰明确
- [ ] 值对象覆盖核心领域概念
- [ ] 仓储接口符合 CQRS 原则

### 可维护性
- [ ] 代码行数减少 10%
- [ ] 圈复杂度降低 20%
- [ ] 服务层代码减少 30%
- [ ] 文档完整且最新

---

## 🚨 风险管理

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 重构导致测试失败 | 中 | 高 | 小步迭代，每步都跑测试 |
| 时间估算不足 | 中 | 中 | 优先完成 P0，P1/P2 可延后 |
| 团队理解 DDD 不足 | 低 | 中 | 提前组织 DDD 培训/分享会 |
| 性能回归 | 低 | 中 | 性能测试基线对比 |

---

## 💡 快速决策指南

### 遇到问题时

**Q1: 某个类不确定是否孤立？**
```bash
grep -r "ClassName" src/ --exclude="ClassName.java"
# 如果只有自身引用 → 孤立
# 如果有其他引用 → 保留并标记 TODO
```

**Q2: 不确定某个方法应该在聚合还是服务层？**
- 如果涉及单个聚合的业务逻辑 → 放在聚合
- 如果涉及多个聚合的协调 → 放在服务层
- 如果是纯技术操作（持久化、事件发布）→ 放在服务层

**Q3: 值对象 vs 实体？**
- 需要唯一标识且有生命周期 → 实体
- 只关心属性值，可替换 → 值对象
- 例如：TaskId（值对象），TaskAggregate（实体）

**Q4: 测试失败怎么办？**
1. 先确认是代码问题还是测试需要更新
2. 如果是测试需要更新 → 同步更新测试
3. 如果是代码问题 → 回退并小步重构
4. 无法解决 → 在团队群里求助

---

## 📞 联系方式

- **技术评审**: 提交 PR 并标注 @reviewer
- **问题讨论**: 团队技术群
- **文档更新**: 同步更新 develop.log

---

**祝重构顺利！让我们一起把 DDD 符合度从 50% 提升到 80%！🚀**

---

_最后更新: 2025-11-17 by GitHub Copilot_

