@startuml Task状态机
!theme plain
hide empty description

[*] --> CREATED : 创建任务

CREATED --> VALIDATING : 开始验证

VALIDATING --> VALIDATION_FAILED : 验证失败
VALIDATING --> PENDING : 验证通过

VALIDATION_FAILED --> [*]

PENDING --> RUNNING : 开始执行
PENDING --> CANCELLED : 取消

RUNNING --> PAUSED : 暂停请求\n[pauseRequested=true]
RUNNING --> COMPLETED : 所有Stage完成\n[currentStageIndex >= totalStages]
RUNNING --> FAILED : Stage失败
RUNNING --> ROLLING_BACK : 手动回滚

PAUSED --> RESUMING : 恢复请求
PAUSED --> ROLLING_BACK : 回滚请求
PAUSED --> CANCELLED : 取消请求

RESUMING --> RUNNING : 从checkpoint恢复

FAILED --> RUNNING : 重试\n[retryCount < maxRetry]
FAILED --> ROLLING_BACK : 回滚请求

COMPLETED --> ROLLING_BACK : 回滚请求

ROLLING_BACK --> ROLLED_BACK : 回滚成功
ROLLING_BACK --> ROLLBACK_FAILED : 回滚失败

ROLLBACK_FAILED --> ROLLING_BACK : 重试回滚

ROLLED_BACK --> [*]
CANCELLED --> [*]

note right of CREATED
  **初始状态**
  - 任务创建时的初始状态
  - 包含租户和部署单元信息
end note

note right of RUNNING
  **执行状态**
  - 顺序执行 Stage 列表
  - 仅在 Stage 边界响应暂停/取消
  - 每个 Stage 完成后保存 checkpoint
  - 记录 startedAt 时间戳
end note

note right of PAUSED
  **暂停状态**
  - 协作式暂停（Stage 边界）
  - checkpoint 已保存
  - 可恢复、回滚或取消
end note

note right of FAILED
  **失败状态**
  - Stage 执行失败
  - 可重试（受 maxRetry 限制）
  - 可回滚
end note

note right of COMPLETED
  **完成状态**
  - 所有 Stage 成功执行
  - 记录 endedAt 和 durationMillis
  - 清理 checkpoint
  - 可回滚（业务需要时）
end note

note right of ROLLING_BACK
  **回滚中**
  - 按 Stage 列表逆序执行回滚
  - 恢复 prevConfigSnapshot
  - 发布 Stage 级回滚事件
end note

note right of ROLLED_BACK
  **回滚完成**
  - 快照恢复到聚合
  - 健康确认后更新 lastKnownGoodVersion
  - 记录 endedAt 和 durationMillis
  - 终态
end note

note left of VALIDATION_FAILED
  **验证失败**
  - 租户配置不合法
  - 部署单元信息缺失
  - 终态，不可恢复
end note

note left of CANCELLED
  **已取消**
  - 用户主动取消
  - 事件包含 cancelledBy 和 lastStage
  - 释放租户锁
  - 终态
end note

note left of ROLLBACK_FAILED
  **回滚失败**
  - 部分 Stage 回滚失败
  - 可重试回滚
  - 发布 partiallyRolledBackStages
end note

@enduml

