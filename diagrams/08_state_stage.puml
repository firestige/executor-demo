@startuml Stage执行流程
!theme plain
hide empty description

[*] --> PENDING : Stage 创建

PENDING --> EXECUTING : 开始执行

state EXECUTING {
  [*] --> STEP_1
  STEP_1 --> STEP_2 : 成功
  STEP_2 --> STEP_N : 成功
  STEP_N --> [*] : 成功

  STEP_1 --> FAILED : 失败（短路）
  STEP_2 --> FAILED : 失败（短路）
  STEP_N --> FAILED : 失败（短路）
}

EXECUTING --> SUCCEEDED : 所有 Step 成功
EXECUTING --> FAILED : 任一 Step 失败
EXECUTING --> SKIPPED : 条件不满足

SUCCEEDED --> CHECKPOINT : 保存检查点
CHECKPOINT --> [*]

FAILED --> [*]
SKIPPED --> [*]

note right of PENDING
  **等待执行**
  - Stage 已注册
  - 等待前序 Stage 完成
end note

note right of EXECUTING
  **执行中**
  - 按顺序执行 Step 列表
  - 任一 Step 失败则短路
  - Step 类型：
    * ConfigUpdateStep
    * BroadcastStep
    * HealthCheckStep
end note

note right of SUCCEEDED
  **成功**
  - 所有 Step 执行成功
  - 触发 checkpoint 保存
  - 发布 StageCompletedEvent
end note

note left of FAILED
  **失败**
  - Step 执行失败
  - 中断 Stage 执行
  - 发布 StageFailedEvent
  - 触发 Task 失败
end note

note left of SKIPPED
  **跳过**
  - canSkip() 返回 true
  - 不执行 Step
  - 记录跳过原因
  - 仍保存 checkpoint
end note

state "HealthCheckStep 执行细节" as HEALTH_CHECK {
  [*] --> INIT_CHECK
  INIT_CHECK --> POLLING : 开始轮询

  state POLLING {
    [*] --> QUERY_ENDPOINTS
    QUERY_ENDPOINTS --> CHECK_VERSION : 获取响应
    CHECK_VERSION --> ALL_MATCH : 所有实例版本匹配
    CHECK_VERSION --> RETRY : 部分实例不匹配
    RETRY --> QUERY_ENDPOINTS : 等待 3 秒
    RETRY --> TIMEOUT : 超过 10 次尝试
  }

  ALL_MATCH --> SUCCESS
  TIMEOUT --> FAILURE

  SUCCESS --> [*]
  FAILURE --> [*]
}

note right of HEALTH_CHECK
  **健康检查细节**
  - 固定 3 秒轮询间隔
  - 最多 10 次尝试
  - 要求所有实例成功
  - 版本键可配置（默认 version）
  - URL 解析支持多种格式
end note

@enduml
@startuml Task状态机
!theme plain
hide empty description

[*] --> CREATED : 创建任务

CREATED --> VALIDATING : 开始验证

VALIDATING --> VALIDATION_FAILED : 验证失败
VALIDATING --> PENDING : 验证通过

VALIDATION_FAILED --> [*]

PENDING --> RUNNING : 开始执行
PENDING --> CANCELLED : 取消

RUNNING --> PAUSED : 暂停请求\n[pauseRequested=true]
RUNNING --> COMPLETED : 所有Stage完成\n[currentStageIndex >= totalStages]
RUNNING --> FAILED : Stage失败
RUNNING --> ROLLING_BACK : 手动回滚

PAUSED --> RESUMING : 恢复请求
PAUSED --> ROLLING_BACK : 回滚请求
PAUSED --> CANCELLED : 取消请求

RESUMING --> RUNNING : 从checkpoint恢复

FAILED --> RUNNING : 重试\n[retryCount < maxRetry]
FAILED --> ROLLING_BACK : 回滚请求

COMPLETED --> ROLLING_BACK : 回滚请求

ROLLING_BACK --> ROLLED_BACK : 回滚成功
ROLLING_BACK --> ROLLBACK_FAILED : 回滚失败

ROLLBACK_FAILED --> ROLLING_BACK : 重试回滚

ROLLED_BACK --> [*]
CANCELLED --> [*]

note right of CREATED
  **初始状态**
  - 任务创建时的初始状态
  - 包含租户和部署单元信息
end note

note right of RUNNING
  **执行状态**
  - 顺序执行 Stage 列表
  - 仅在 Stage 边界响应暂停/取消
  - 每个 Stage 完成后保存 checkpoint
  - 记录 startedAt 时间戳
end note

note right of PAUSED
  **暂停状态**
  - 协作式暂停（Stage 边界）
  - checkpoint 已保存
  - 可恢复、回滚或取消
end note

note right of FAILED
  **失败状态**
  - Stage 执行失败
  - 可重试（受 maxRetry 限制）
  - 可回滚
end note

note right of COMPLETED
  **完成状态**
  - 所有 Stage 成功执行
  - 记录 endedAt 和 durationMillis
  - 清理 checkpoint
  - 可回滚（业务需要时）
end note

note right of ROLLING_BACK
  **回滚中**
  - 按 Stage 列表逆序执行回滚
  - 恢复 prevConfigSnapshot
  - 发布 Stage 级回滚事件
end note

note right of ROLLED_BACK
  **回滚完成**
  - 快照恢复到聚合
  - 健康确认后更新 lastKnownGoodVersion
  - 记录 endedAt 和 durationMillis
  - 终态
end note

note left of VALIDATION_FAILED
  **验证失败**
  - 租户配置不合法
  - 部署单元信息缺失
  - 终态，不可恢复
end note

note left of CANCELLED
  **已取消**
  - 用户主动取消
  - 事件包含 cancelledBy 和 lastStage
  - 释放租户锁
  - 终态
end note

note left of ROLLBACK_FAILED
  **回滚失败**
  - 部分 Stage 回滚失败
  - 可重试回滚
  - 发布 partiallyRolledBackStages
end note

@enduml

