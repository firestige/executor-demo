# Redis ç»­æœŸæœåŠ¡è®¾è®¡æ–‡æ¡£

> **ä»»åŠ¡ ID**: T-018  
> **ç‰ˆæœ¬**: v1.0  
> **çŠ¶æ€**: è®¾è®¡å®Œæˆ  
> **æœ€åæ›´æ–°**: 2025-11-24

---

## 1. æ¦‚è¿°

Redis ç»­æœŸæœåŠ¡æ˜¯ä¸€ä¸ªé€šç”¨çš„ã€å¯å¤ç”¨çš„åŸºç¡€è®¾æ–½ç»„ä»¶ï¼Œç”¨äºè‡ªåŠ¨ç»´æŠ¤ Redis Key çš„è¿‡æœŸæ—¶é—´ï¼ˆTTLï¼‰ï¼Œé¿å…å›  TTL è¿‡æœŸå¯¼è‡´çš„æ•°æ®ä¸¢å¤±ã€‚

### 1.1 æ ¸å¿ƒç›®æ ‡

- **é€šç”¨å¯å¤ç”¨**ï¼šç‹¬ç«‹äºä¸šåŠ¡åŸŸï¼Œå¯åœ¨ä»»ä½•é¡¹ç›®ä¸­ä½¿ç”¨
- **é«˜æ€§èƒ½**ï¼šå•çº¿ç¨‹æ”¯æŒå¤§é‡å¹¶å‘ç»­æœŸä»»åŠ¡
- **çµæ´»æ‰©å±•**ï¼šæä¾›ä¸°å¯Œçš„æ‰©å±•ç‚¹ï¼Œæ”¯æŒå¤æ‚ä¸šåŠ¡åœºæ™¯
- **æ˜“äºä½¿ç”¨**ï¼šå¼€ç®±å³ç”¨çš„é¢„ç½®å®ç° + ç®€æ´çš„ API

### 1.2 é€‚ç”¨åœºæ™¯

| åœºæ™¯ | è¯´æ˜ |
|------|------|
| é•¿æ—¶é—´ä»»åŠ¡ | ä»»åŠ¡æ‰§è¡Œæ—¶é—´ä¸ç¡®å®šï¼Œéœ€è¦æŒç»­ä¿æŒ Redis æ•°æ®æœ‰æ•ˆæ€§ |
| åˆ†å¸ƒå¼é” | ç»´æŒåˆ†å¸ƒå¼é”çš„æœ‰æ•ˆæœŸï¼Œé¿å…è¿‡æ—©é‡Šæ”¾ |
| ä¼šè¯ä¿æŒ | ç»´æŠ¤ç”¨æˆ·ä¼šè¯æ•°æ®çš„ TTL |
| ç¼“å­˜é¢„çƒ­ | ä¿æŒçƒ­ç‚¹æ•°æ®ä¸è¿‡æœŸ |
| éƒ¨ç½²æµç¨‹ | éƒ¨ç½²è¿‡ç¨‹ä¸­ç»´æŒé…ç½®æ•°æ®å’ŒçŠ¶æ€çš„æœ‰æ•ˆæ€§ |

---

## 2. æ¶æ„è®¾è®¡

### 2.1 åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  API å±‚ï¼ˆæ ¸å¿ƒæŠ½è±¡æ¥å£ï¼‰                           â”‚
â”‚  - KeyRenewalServiceï¼ˆæœåŠ¡æ¥å£ï¼‰                 â”‚
â”‚  - RenewalStrategyï¼ˆç»­æœŸç­–ç•¥ï¼‰                   â”‚
â”‚  - KeySelectorï¼ˆKey é€‰æ‹©å™¨ï¼‰                     â”‚
â”‚  - StopConditionï¼ˆåœæ­¢æ¡ä»¶ï¼‰                     â”‚
â”‚  - RedisClientï¼ˆRedis å®¢æˆ·ç«¯æŠ½è±¡ï¼‰â­             â”‚
â”‚  + 6 ä¸ªé«˜çº§æ‰©å±•ç‚¹                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†‘
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Core å±‚      â”‚ â”‚ Strategy  â”‚ â”‚ Generator   â”‚
â”‚ (æ ¸å¿ƒå®ç°)   â”‚ â”‚ (ç­–ç•¥å®ç°)â”‚ â”‚ (ç”Ÿæˆå™¨)    â”‚
â”‚              â”‚ â”‚           â”‚ â”‚             â”‚
â”‚ - æ—¶é—´è½®è°ƒåº¦ â”‚ â”‚ - 20ç§é¢„ç½®â”‚ â”‚ - 5ç§é¢„ç½®   â”‚
â”‚ - å¼‚æ­¥æ‰§è¡Œå™¨â­â”‚ â”‚           â”‚ â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â†‘
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client/Spring    â”‚   â”‚ Client/Jedis        â”‚
â”‚ (Spring é€‚é…å™¨)  â”‚   â”‚ (Jedis é€‚é…å™¨)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä¾èµ–å…³ç³»**ï¼š
- API å±‚ï¼šæ— å¤–éƒ¨ä¾èµ–ï¼ˆçº¯æ¥å£ï¼‰
- Core å±‚ï¼šä¾èµ– API + Nettyï¼ˆæ—¶é—´è½®ï¼‰
- Client å±‚ï¼šä¾èµ– API + å…·ä½“ Redis å®¢æˆ·ç«¯åº“

### 2.2 æ¨¡å—åŒ–è®¾è®¡

```
redis-renewal-api.jar         # æ ¸å¿ƒæ¥å£ï¼ˆæ— ä¾èµ–ï¼‰
redis-renewal-core.jar        # æ ¸å¿ƒå®ç°ï¼ˆä¾èµ– Nettyï¼‰
redis-renewal-spring.jar      # Spring é›†æˆï¼ˆå¯é€‰ï¼‰
redis-renewal-jedis.jar       # Jedis é›†æˆï¼ˆå¯é€‰ï¼‰
redis-renewal-lettuce.jar     # Lettuce é›†æˆï¼ˆå¯é€‰ï¼‰
```

**ä¼˜åŠ¿**ï¼š
- âœ… æ ¸å¿ƒé€»è¾‘å¯è„±ç¦» Spring
- âœ… æ”¯æŒå¤šç§ Redis å®¢æˆ·ç«¯
- âœ… ä¾¿äºåç»­æ‹†åŒ…å’Œç‹¬ç«‹å‘å¸ƒ
- âœ… ç”¨æˆ·å¯æŒ‰éœ€å¼•å…¥ä¾èµ–

---

## 3. å…³é”®è®¾è®¡å†³ç­–

### 3.1 è§£å†³æ—¶é—´è½® IO é˜»å¡é—®é¢˜

**é—®é¢˜**ï¼šæ—¶é—´è½®çš„ tick çº¿ç¨‹æ‰§è¡Œ Redis æ“ä½œæ—¶å¦‚æœå‘ç”Ÿç½‘ç»œé˜»å¡ï¼Œä¼šå½±å“è°ƒåº¦ç²¾åº¦ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šæ—¶é—´è½®ä¸ IO æ“ä½œåˆ†ç¦»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     æäº¤ä»»åŠ¡      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ—¶é—´è½®çº¿ç¨‹     â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”‚  å¼‚æ­¥æ‰§è¡Œå™¨       â”‚
â”‚  (è°ƒåº¦)        â”‚     (ä¸ç­‰å¾…)      â”‚  (IO çº¿ç¨‹æ± )      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â†“                                      â†“
  å¿«é€Ÿè¿”å›                              æ‰§è¡Œ Redis æ“ä½œ
  ç»§ç»­è°ƒåº¦                              (å¯èƒ½é˜»å¡)
```

**å®ç°æœºåˆ¶**ï¼š

1. **æ—¶é—´è½®å›è°ƒ**ï¼ˆå¿«é€Ÿè¿”å›ï¼‰ï¼š
   - åªè®¡ç®— TTL å’Œé€‰æ‹© Key
   - æäº¤ä»»åŠ¡åˆ°å¼‚æ­¥æ‰§è¡Œå™¨
   - ç«‹å³è°ƒåº¦ä¸‹æ¬¡ç»­æœŸ

2. **å¼‚æ­¥æ‰§è¡Œå™¨**ï¼ˆç‹¬ç«‹çº¿ç¨‹æ± ï¼‰ï¼š
   - åœ¨ç‹¬ç«‹çº¿ç¨‹æ± ä¸­æ‰§è¡Œ Redis IO
   - ä½¿ç”¨ `CompletableFuture` å¼‚æ­¥å¤„ç†ç»“æœ
   - å¤±è´¥ä¸å½±å“æ—¶é—´è½®è°ƒåº¦

**æ•ˆæœ**ï¼š
- âœ… æ—¶é—´è½®è°ƒåº¦ç²¾åº¦ä¸å— Redis IO å½±å“
- âœ… æ”¯æŒå¹¶å‘ç»­æœŸï¼ˆå¤šä¸ªçº¿ç¨‹å¹¶è¡Œæ‰§è¡Œ IOï¼‰
- âœ… å¤±è´¥ä¸å½±å“åç»­è°ƒåº¦

---

### 3.2 Redis å®¢æˆ·ç«¯æŠ½è±¡

**é—®é¢˜**ï¼šæ ¸å¿ƒé€»è¾‘ä¸å…·ä½“ Redis å®¢æˆ·ç«¯å®ç°è€¦åˆï¼Œéš¾ä»¥æ”¯æŒå¤šç§å®ç°ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå®šä¹‰ `RedisClient` æŠ½è±¡æ¥å£

```java
public interface RedisClient {
    boolean expire(String key, long ttl);
    Map<String, Boolean> batchExpire(Collection<String> keys, long ttl);
    CompletableFuture<Boolean> expireAsync(String key, long ttl);
    CompletableFuture<Map<String, Boolean>> batchExpireAsync(...);
    Collection<String> scan(String pattern, int count);
    // ...
}
```

**å¤šç§å®ç°**ï¼š
- `SpringRedisClient`ï¼šåŸºäº Spring Data Redis
- `JedisRedisClient`ï¼šåŸºäº Jedis
- `LettuceRedisClient`ï¼šåŸºäº Lettuce

**åŠ è½½æœºåˆ¶**ï¼š
- Spring ç¯å¢ƒï¼šé€šè¿‡ `@Bean` è‡ªåŠ¨è£…é…
- é Spring ç¯å¢ƒï¼šé€šè¿‡ SPI åŠ è½½

**ä¼˜åŠ¿**ï¼š
- âœ… æ ¸å¿ƒé€»è¾‘æ— ç‰¹å®šå®¢æˆ·ç«¯ä¾èµ–
- âœ… æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰å®ç°
- âœ… ä¾¿äºæµ‹è¯•ï¼ˆMock RedisClientï¼‰

---

### 3.3 æ‰©å±•ç‚¹è®¾è®¡ç­–ç•¥

**åŸåˆ™**ï¼šæ‰€æœ‰æ‰©å±•ç‚¹éƒ½é‡‡ç”¨ï¼Œä½†æ ¹æ®ä½¿ç”¨é¢‘ç‡å†³å®šé¢„ç½®å®ç°çš„ä¸°å¯Œç¨‹åº¦ã€‚

| æ‰©å±•ç‚¹ç±»å‹ | é¢„ç½®å®ç°ç­–ç•¥ | æ•°é‡ |
|-----------|-------------|------|
| ğŸ”´ é«˜é¢‘æ‰©å±•ç‚¹ | ä¸°å¯Œå®ç°ï¼ˆ4-6 ç§ï¼‰ | 20 ç§ |
| ğŸŸ¡ ä¸­é¢‘æ‰©å±•ç‚¹ | æœ€å°å®ç°ï¼ˆ1 ç§é»˜è®¤ï¼‰ | 4 ç§ |
| ğŸŸ¢ ä½é¢‘æ‰©å±•ç‚¹ | æœ€å°å®ç°ï¼ˆ1 ç§é»˜è®¤ï¼‰ | 2 ç§ |

**é«˜é¢‘æ‰©å±•ç‚¹**ï¼ˆ20 ç§é¢„ç½®å®ç°ï¼‰ï¼š
- `RenewalStrategy`ï¼ˆ5 ç§ï¼‰ï¼šå›ºå®šTTLã€åŠ¨æ€TTLã€ç»­æœŸè‡³æŒ‡å®šæ—¶é—´ã€æœ€å¤§æ¬¡æ•°ã€æ¡ä»¶åˆ¤æ–­
- `RenewalIntervalStrategy`ï¼ˆ4 ç§ï¼‰ï¼šå›ºå®šé—´éš”ã€æŒ‡æ•°é€€é¿ã€è‡ªé€‚åº”ã€éšæœºæŠ–åŠ¨
- `KeySelector`ï¼ˆ5 ç§ï¼‰ï¼šé™æ€åˆ—è¡¨ã€æ¨¡å¼åŒ¹é…ã€å‰ç¼€æ‰«æã€å‡½æ•°å¼ã€ç»„åˆ
- `StopCondition`ï¼ˆ6 ç§ï¼‰ï¼šæ°¸ä¸åœæ­¢ã€æ—¶é—´åœæ­¢ã€æ¬¡æ•°åœæ­¢ã€Keyä¸å­˜åœ¨ã€å¤–éƒ¨ä¿¡å·ã€ç»„åˆ

**ä¸­ä½é¢‘æ‰©å±•ç‚¹**ï¼ˆ6 ç§æœ€å°å®ç°ï¼‰ï¼š
- `FailureHandler`ï¼šè®°å½•æ—¥å¿—å¹¶ç»§ç»­
- `RenewalLifecycleListener`ï¼šç©ºå®ç°
- `RenewalFilter`ï¼šç›´é€šè¿‡æ»¤å™¨
- `BatchStrategy`ï¼šå›ºå®šæ‰¹æ¬¡å¤§å°
- `KeyGenerationStrategy`ï¼šå ä½ç¬¦æ›¿æ¢
- `RenewalScheduler`ï¼šæ—¶é—´è½®è°ƒåº¦å™¨

**ä¼˜åŠ¿**ï¼š
- âœ… æ¶æ„å®Œæ•´æ€§ï¼ˆæ‰€æœ‰æ‰©å±•ç‚¹éƒ½æœ‰å®šä¹‰ï¼‰
- âœ… å®æ–½æˆæœ¬å¯æ§ï¼ˆ26 ç§å®ç°ï¼Œç›¸æ¯”å…¨åŠŸèƒ½å‡å°‘ 50%+ï¼‰
- âœ… ç”¨æˆ·ä½“éªŒä¼˜ç§€ï¼ˆé«˜é¢‘åœºæ™¯å¼€ç®±å³ç”¨ï¼Œä¸­ä½é¢‘æ˜“äºæ‰©å±•ï¼‰
- âœ… ç»´æŠ¤æˆæœ¬ä½ï¼ˆåªç»´æŠ¤é«˜é¢‘å®ç°ï¼‰

---

## 4. æ ¸å¿ƒç»„ä»¶

### 4.1 TimeWheelRenewalServiceï¼ˆæ—¶é—´è½®ç»­æœŸæœåŠ¡ï¼‰

**èŒè´£**ï¼š
- ä»»åŠ¡è°ƒåº¦ï¼ˆä¸æ‰§è¡Œ IOï¼‰
- ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸç®¡ç†
- ä¸å¼‚æ­¥æ‰§è¡Œå™¨åä½œ

**å…³é”®è®¾è®¡**ï¼š
```java
private void handleRenewalTick(RenewalTaskWrapper wrapper) {
    // â­ åªè®¡ç®—å’Œæäº¤ï¼Œä¸æ‰§è¡Œ IO
    long ttl = strategy.calculateTtl(context);
    Collection<String> keys = selector.selectKeys(context);
    
    // â­ æäº¤åˆ°å¼‚æ­¥æ‰§è¡Œå™¨ï¼ˆä¸é˜»å¡ï¼‰
    asyncExecutor.submitRenewal(taskId, keys, ttl)
        .whenComplete((result, ex) -> {
            // å¼‚æ­¥å¤„ç†ç»“æœ
        });
    
    // â­ ç«‹å³è°ƒåº¦ä¸‹æ¬¡ç»­æœŸ
    scheduleRenewal(wrapper);
}
```

---

### 4.2 AsyncRenewalExecutorï¼ˆå¼‚æ­¥æ‰§è¡Œå™¨ï¼‰

**èŒè´£**ï¼š
- æ¥æ”¶æ—¶é—´è½®æäº¤çš„ç»­æœŸä»»åŠ¡
- å¼‚æ­¥æ‰§è¡Œ Redis æ“ä½œ
- ç»“æœå›è°ƒå¤„ç†

**çº¿ç¨‹æ± é…ç½®**ï¼š
```java
new ThreadPoolExecutor(
    threadPoolSize,          // æ ¸å¿ƒçº¿ç¨‹æ•°
    threadPoolSize,          // æœ€å¤§çº¿ç¨‹æ•°
    60L, TimeUnit.SECONDS,   // ç©ºé—²è¶…æ—¶
    new ArrayBlockingQueue<>(1000),  // æœ‰ç•Œé˜Ÿåˆ—
    new CallerRunsPolicy()   // é˜Ÿåˆ—æ»¡æ—¶é™çº§
);
```

**å®¹é”™æœºåˆ¶**ï¼š
- é˜Ÿåˆ—æ»¡æ—¶ä½¿ç”¨ `CallerRunsPolicy`ï¼ˆé™çº§åˆ°åŒæ­¥ï¼‰
- Redis å¤±è´¥ä¸å½±å“ä¸‹æ¬¡è°ƒåº¦
- å¼‚å¸¸éš”ç¦»ï¼Œä¸ä¼ æ’­åˆ°æ—¶é—´è½®

---

### 4.3 RedisClient å®ç°

**Spring Data Redis å®ç°**ï¼š
```java
public class SpringRedisClient implements RedisClient {
    private final RedisTemplate<String, String> redisTemplate;
    
    @Override
    public Map<String, Boolean> batchExpire(Collection<String> keys, long ttl) {
        // ä½¿ç”¨ Pipeline æ‰¹é‡æ‰§è¡Œ
        redisTemplate.executePipelined((RedisCallback<Object>) connection -> {
            for (String key : keys) {
                connection.expire(key.getBytes(), ttl);
            }
            return null;
        });
        // ...
    }
}
```

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- æ‰¹é‡æ“ä½œå‡å°‘ç½‘ç»œå¾€è¿”
- Pipeline æé«˜ååé‡
- SCAN å‘½ä»¤é¿å…é˜»å¡

---

## 5. æ€§èƒ½æŒ‡æ ‡

### 5.1 ç›®æ ‡æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å¤‡æ³¨ |
|------|--------|------|
| å•ä»»åŠ¡ç»­æœŸå»¶è¿Ÿ | < 100ms | ä»è°ƒåº¦åˆ°å®Œæˆ |
| CPU å ç”¨ | < 5% | 1000 ä¸ªå¹¶å‘ä»»åŠ¡ |
| å†…å­˜å ç”¨ | < 100MB | 1000 ä¸ªå¹¶å‘ä»»åŠ¡ |
| ç»­æœŸæˆåŠŸç‡ | > 99.9% | æ­£å¸¸ç½‘ç»œç¯å¢ƒ |
| è°ƒåº¦ç²¾åº¦ | Â±50ms | æ—¶é—´è½® tick é—´éš” 100ms |

### 5.2 æ€§èƒ½ä¼˜åŒ–

**æ—¶é—´è½®ä¼˜åŒ–**ï¼š
- Tick é—´éš”ï¼š100msï¼ˆå¹³è¡¡ç²¾åº¦å’Œå¼€é”€ï¼‰
- æ§½æ•°ï¼š512ï¼ˆé€‚åˆå¤§å¤šæ•°åœºæ™¯ï¼‰
- å•çº¿ç¨‹è°ƒåº¦ï¼ˆé¿å…ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼‰

**æ‰¹é‡ä¼˜åŒ–**ï¼š
- é»˜è®¤æ‰¹æ¬¡å¤§å°ï¼š100
- ä½¿ç”¨ Redis Pipeline
- å¼‚æ­¥å¹¶å‘æ‰§è¡Œ

**å†…å­˜ä¼˜åŒ–**ï¼š
- ä»»åŠ¡å®Œæˆåè‡ªåŠ¨æ¸…ç†
- ä½¿ç”¨å¯¹è±¡æ± ï¼ˆå¯é€‰ï¼‰
- å®šæœŸ GC å·²å®Œæˆä»»åŠ¡

---

## 6. ç›‘æ§ä¸å¯è§‚æµ‹æ€§

### 6.1 æŒ‡æ ‡æ”¶é›†

**ä»»åŠ¡çº§æŒ‡æ ‡**ï¼š
```java
public class TaskMetrics {
    private long totalRenewals;         // æ€»ç»­æœŸæ¬¡æ•°
    private long successCount;          // æˆåŠŸ Key æ•°
    private long failureCount;          // å¤±è´¥ Key æ•°
    private long taskFailures;          // ä»»åŠ¡å¤±è´¥æ¬¡æ•°
    private double successRate;         // æˆåŠŸç‡
    private Duration averageDuration;   // å¹³å‡è€—æ—¶
}
```

**ç³»ç»Ÿçº§æŒ‡æ ‡**ï¼š
- æ´»è·ƒä»»åŠ¡æ•°
- å¾…è°ƒåº¦ä»»åŠ¡æ•°
- çº¿ç¨‹æ± ä½¿ç”¨ç‡
- Redis è¿æ¥æ± çŠ¶æ€

### 6.2 å¥åº·æ£€æŸ¥

```java
@Component
public class RenewalHealthIndicator implements HealthIndicator {
    @Override
    public Health health() {
        // æ£€æŸ¥æ´»è·ƒä»»åŠ¡æ•°
        // æ£€æŸ¥ç»­æœŸæˆåŠŸç‡
        // æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€
        
        if (hasHighFailureRate) {
            return Health.status("WARNING")
                .withDetail("message", "éƒ¨åˆ†ä»»åŠ¡ç»­æœŸå¤±è´¥ç‡è¾ƒé«˜")
                .build();
        }
        
        return Health.up().build();
    }
}
```

### 6.3 æ—¥å¿—ç­–ç•¥

| çº§åˆ« | å†…å®¹ | é¢‘ç‡ |
|------|------|------|
| INFO | ä»»åŠ¡æ³¨å†Œ/å®Œæˆ/å–æ¶ˆ | æ¯æ¬¡ |
| INFO | æŒ‡æ ‡æŠ¥å‘Š | æ¯åˆ†é’Ÿ |
| DEBUG | ç»­æœŸæ‰§è¡Œè¯¦æƒ… | æ¯æ¬¡ |
| WARN | ç»­æœŸå¤±è´¥ï¼ˆå•ä¸ª Keyï¼‰ | æ¯æ¬¡ |
| ERROR | ä»»åŠ¡å¤±è´¥ | æ¯æ¬¡ |

---

## 7. é…ç½®è®¾è®¡

### 7.1 é…ç½®å±æ€§

```yaml
redis:
  renewal:
    enabled: true
    type: time-wheel  # time-wheel | scheduled
    
    # æ—¶é—´è½®é…ç½®
    time-wheel:
      tick-duration: 100        # Tick é—´éš”ï¼ˆæ¯«ç§’ï¼‰
      ticks-per-wheel: 512      # æ§½æ•°
    
    # å¼‚æ­¥æ‰§è¡Œå™¨é…ç½®
    executor-thread-pool-size: 4  # çº¿ç¨‹æ± å¤§å°
    
    # ç›‘æ§é…ç½®
    metrics-report-interval: 60   # æŒ‡æ ‡æŠ¥å‘Šé—´éš”ï¼ˆç§’ï¼‰
    
    # é»˜è®¤å€¼
    default-renewal-interval: 30  # é»˜è®¤ç»­æœŸé—´éš”ï¼ˆç§’ï¼‰
    default-ttl: 300              # é»˜è®¤ TTLï¼ˆç§’ï¼‰
```

### 7.2 Spring Boot è‡ªåŠ¨é…ç½®

```java
@AutoConfiguration
@ConditionalOnClass(RedisTemplate.class)
@EnableConfigurationProperties(RedisRenewalProperties.class)
public class RedisRenewalAutoConfiguration {
    
    @Bean
    @ConditionalOnMissingBean
    public RedisClient redisClient(RedisTemplate<String, String> redisTemplate) {
        return new SpringRedisClient(redisTemplate);
    }
    
    @Bean
    @ConditionalOnMissingBean
    public KeyRenewalService renewalService(
            RedisClient redisClient,
            RedisRenewalProperties properties) {
        return new TimeWheelRenewalService(redisClient, properties);
    }
}
```

---

## 8. æµ‹è¯•ç­–ç•¥

### 8.1 å•å…ƒæµ‹è¯•

- æ‰©å±•ç‚¹æ¥å£å®ç°ï¼ˆ26 ç§ï¼‰
- æ ¸å¿ƒé€»è¾‘ï¼ˆè°ƒåº¦ã€æ‰§è¡Œã€å®¹é”™ï¼‰
- è¾¹ç•Œæ¡ä»¶ï¼ˆç©º Keyã€ç½‘ç»œå¼‚å¸¸ï¼‰

### 8.2 é›†æˆæµ‹è¯•

- Redis çœŸå®è¿æ¥
- å¤šä»»åŠ¡å¹¶å‘
- å¤±è´¥é‡è¯•
- å¥åº·æ£€æŸ¥ç«¯ç‚¹

### 8.3 æ€§èƒ½æµ‹è¯•

- 1000+ å¹¶å‘ä»»åŠ¡
- é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§
- å†…å­˜æ³„æ¼æ£€æµ‹
- CPU å’Œå†…å­˜å ç”¨

### 8.4 å‹åŠ›æµ‹è¯•

- æé™å¹¶å‘æ•°
- Redis è¿æ¥æ± è€—å°½åœºæ™¯
- ç½‘ç»œå»¶è¿Ÿæ¨¡æ‹Ÿ
- çº¿ç¨‹æ± æ»¡è½½åœºæ™¯

---

## 9. éƒ¨ç½²å»ºè®®

### 9.1 èµ„æºé…ç½®

**ç”Ÿäº§ç¯å¢ƒ**ï¼š
- çº¿ç¨‹æ± å¤§å°ï¼š4-8ï¼ˆæ ¹æ® Key æ•°é‡è°ƒæ•´ï¼‰
- æ—¶é—´è½® tick é—´éš”ï¼š100ms
- JVM å †å†…å­˜ï¼šâ‰¥ 512MB

**å¼€å‘ç¯å¢ƒ**ï¼š
- çº¿ç¨‹æ± å¤§å°ï¼š2
- æ—¶é—´è½® tick é—´éš”ï¼š100ms
- JVM å †å†…å­˜ï¼šâ‰¥ 256MB

### 9.2 ç›‘æ§å‘Šè­¦

**å‘Šè­¦è§„åˆ™**ï¼š
- ç»­æœŸæˆåŠŸç‡ < 95%
- æ´»è·ƒä»»åŠ¡æ•° > 1000
- çº¿ç¨‹æ± é˜Ÿåˆ—ä½¿ç”¨ç‡ > 80%
- å•ä»»åŠ¡ç»­æœŸå»¶è¿Ÿ > 500ms

### 9.3 è¿ç»´å»ºè®®

- å®šæœŸæŸ¥çœ‹æŒ‡æ ‡æŠ¥å‘Š
- ç›‘æ§ Redis è¿æ¥æ± çŠ¶æ€
- å…³æ³¨ ERROR å’Œ WARN æ—¥å¿—
- å®šæœŸæ¸…ç†å·²å®Œæˆä»»åŠ¡ï¼ˆè‡ªåŠ¨ï¼‰

---

## 10. æœªæ¥æ‰©å±•

### 10.1 çŸ­æœŸæ‰©å±•ï¼ˆ3 ä¸ªæœˆå†…ï¼‰

- [ ] æ”¯æŒ Lettuce å®¢æˆ·ç«¯
- [ ] æ·»åŠ æ›´å¤šé«˜çº§æ‰©å±•ç‚¹å®ç°
- [ ] æä¾› Grafana Dashboard

### 10.2 ä¸­æœŸæ‰©å±•ï¼ˆ6 ä¸ªæœˆå†…ï¼‰

- [ ] æ”¯æŒç»­æœŸä»»åŠ¡æŒä¹…åŒ–ï¼ˆé‡å¯æ¢å¤ï¼‰
- [ ] æ”¯æŒåˆ†å¸ƒå¼åè°ƒï¼ˆå¤šå®ä¾‹ï¼‰
- [ ] æä¾› Web ç®¡ç†ç•Œé¢

### 10.3 é•¿æœŸæ‰©å±•ï¼ˆ1 å¹´å†…ï¼‰

- [ ] æ”¯æŒå…¶ä»– KV å­˜å‚¨ï¼ˆEtcdã€Consulï¼‰
- [ ] æä¾› Prometheus é›†æˆ
- [ ] æ”¯æŒåŠ¨æ€é…ç½®çƒ­æ›´æ–°

---

## 11. å‚è€ƒèµ„æ–™

### 11.1 æŠ€æœ¯æ–‡æ¡£

- [Netty HashedWheelTimer](https://netty.io/4.1/api/io/netty/util/HashedWheelTimer.html)
- [Spring Data Redis](https://docs.spring.io/spring-data/redis/docs/current/reference/html/)
- [Redis EXPIRE å‘½ä»¤](https://redis.io/commands/expire/)
- [Hashed and Hierarchical Timing Wheels (è®ºæ–‡)](http://www.cs.columbia.edu/~nahum/w6998/papers/ton97-timing-wheels.pdf)

### 11.2 ç›¸å…³è®¾è®¡

- [T-017 é…ç½®ç®¡ç†ä½“ç³»](configuration-management.md)
- [æ‰©å±•ç‚¹è®¾è®¡æ¸…å•](../temp/task-018-extension-points-design.md)
- [å®æ–½æ–¹æ¡ˆ](../temp/task-018-redis-renewal-service-design.md)

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**ç»´æŠ¤è€…**ï¼šæ¶æ„å›¢é˜Ÿ  
**æœ€åæ›´æ–°**ï¼š2025-11-24

