# ============================================================
# DEPRECATED: This file is obsolete (T-027 Phase4)
# ============================================================
# Migrated to: application.yml executor.infrastructure.*
# New config uses Spring Boot standard placeholders: ${VAR:default}
#
# DO NOT add new configuration here!
# This file will be REMOVED in v2.0
#
# Migration guide:
#   Old: infrastructure.redis.hashKeyPrefix
#   New: executor.infrastructure.redis.hash-key-prefix
#   Old: infrastructure.healthCheck
#   New: executor.infrastructure.verify
#
# Access config via SharedStageResources convenience methods:
#   resources.getRedisHashKeyPrefix()
#   resources.getVerifyMaxAttempts()
# ============================================================
#
# Deployment Stage Configuration for RF-19
# RF-19 使用代码编排（DynamicStageFactory），不依赖 YAML 配置 stages
# 此文件仅保留基础设施配置
# 占位符语法示例: {$VAR_NAME:defaultValue} 若环境变量 VAR_NAME 存在则使用其值，否则使用 defaultValue

# ========== Infrastructure Configuration ==========
infrastructure:
  # Redis Configuration
  redis:
    hashKeyPrefix: "{$REDIS_HASH_PREFIX:icc_ai_ops_srv:tenant_config:}"
    pubsubTopic: "{$REDIS_PUBSUB_TOPIC:icc_ai_ops_srv:tenant_config:topic}"

  # Nacos Service Discovery Configuration
  # enabled: 是否启用 Nacos 服务发现（false 时使用 fallbackInstances）
  # serverAddr: Nacos 服务器地址
  # healthCheckEnabled: 是否对 Nacos 返回的实例进行健康检查
  # services: 服务标识到 Nacos 服务名的映射
  nacos:
    enabled: "{$NACOS_ENABLED:false}"
    serverAddr: "{$NACOS_SERVER_ADDR:127.0.0.1:8848}"
    healthCheckEnabled: "{$NACOS_HEALTH_CHECK_ENABLED:false}"
    services:
      blueGreenGatewayService: "{$NACOS_BG_SERVICE_NAME:blue-green-gateway-service}"
      portalService: "{$NACOS_PORTAL_SERVICE_NAME:portal-service}"
      asbcService: "{$NACOS_ASBC_SERVICE_NAME:asbc-gateway-service}"
      obService: "{$NACOS_OB_SERVICE_NAME:ob-service}"

  # Service Discovery Fallback Configuration
  # Use fixed IPs when Nacos unavailable (可用环境变量覆盖)
  fallbackInstances:
    blue-green-gateway:
      - "{$BG_GW_IP1:192.168.1.10:8080}"
      - "{$BG_GW_IP2:192.168.1.11:8080}"
    portal:
      - "{$PORTAL_IP1:192.168.1.20:8080}"
    asbc:
      - "{$ASBC_IP1:192.168.1.100:8080}"
      - "{$ASBC_IP2:192.168.1.101:8080}"
    ob-service:
      - "{$OB_SVC_IP1:192.168.1.30:8080}"

  # Authentication Configuration
  # RF-19: enabled=false 不填 Authorization header
  #        enabled=true + tokenProvider=random 生成随机 hex
  auth:
    asbc:
      enabled: false
      tokenProvider: "{$ASBC_TOKEN_PROVIDER:random}"
    portal:
      enabled: false
    ob-service:
      enabled: false

  # Health Check Configuration (for Blue-Green Gateway)
  # 注意: intervalSeconds/maxAttempts 为数值类型暂不使用占位符（解析器仅处理字符串）
  healthCheck:
    defaultPath: "{$HEALTH_CHECK_PATH:/actuator/bg-sdk/{tenantId}}"
    intervalSeconds: 3
    maxAttempts: 10

# ========== Default Service Names ==========
# 默认的服务切换顺序（当外部未指定时使用）
defaultServiceNames:
  - asbc-gateway
  - portal
  - blue-green-gateway

# ========== 注意 ==========
# RF-19 使用 DynamicStageFactory 进行代码编排
# Stage 和 Step 的创建逻辑在代码中实现，不依赖 YAML 配置
# 环境变量占位符会在启动时被解析（DeploymentConfigLoader -> EnvironmentPlaceholderResolver）
# 未设置且无默认值的占位符会导致启动失败（除非允许缺失: -Ddeploy.env.placeholder.allow-missing=true）
# 敏感变量可使用 *_SECRET 后缀以在日志中脱敏显示

# Stage 创建位置：
# - DynamicStageFactory.buildStages(TenantConfig)
# - 根据 TenantConfig 动态创建 ASBC、Portal、OBService 等 Stage
#
# Step 类型（通用，可复用）：
# - HttpRequestStep: HTTP 请求（ASBC、Portal 复用）
# - ConfigWriteStep: Redis HSET（OBService、蓝绿网关复用）
# - PollingStep: 轮询（OBService 使用）
# - MessageBroadcastStep: Redis Pub/Sub（蓝绿网关使用）
#
# 业务逻辑位置：
# - DataPreparer: 准备 Step 执行数据
# - ResultValidator: 验证 Step 执行结果
# - ConfigurableServiceStage: 编排 Preparer + Step + Validator
#
# Nacos 服务发现机制 (T-025):
# - ServiceDiscoveryHelper: 核心服务发现逻辑（Nacos + Fallback 降级）
# - 支持缓存（30秒 TTL）和 Failback（标记失败实例）
# - 实例选择策略：
#   * ALL: 多实例并发（BlueGreen/OBService 健康检查）
#   * RANDOM: 随机单实例（Portal/ASBC 负载均衡）
# - Namespace: 从 TenantConfig.nacosNameSpace 动态获取
# - 降级策略: Nacos 失败 → fallbackInstances → 抛出异常
